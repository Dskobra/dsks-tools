#!/usr/bin/bash
install_nvidia(){
    # main drivers
    sudo zypper -n install --auto-agree-with-licenses openSUSE-repos-Tumbleweed-NVIDIA

    sudo zypper al nvidia-open-driver-G06-signed-kmp-default
    sudo zypper al nvidia-open-driver-G07-signed-kmp-default

    sudo zypper al nvidia-open-driver-G06-signed-kmp-longterm
    sudo zypper al nvidia-open-driver-G07-signed-kmp-longterm

    sudo zypper al nvidia-open-driver-G06-signed-cuda-kmp-default
    sudo zypper al nvidia-open-driver-G07-signed-cuda-kmp-default

    # cuda drivers
    sudo zypper al nvidia-open-driver-G06-signed-cuda-kmp-longterm
    sudo zypper al nvidia-open-driver-G07-signed-cuda-kmp-longterm

    sudo zypper --gpg-auto-import-keys -n ref
    sudo zypper -n install --auto-agree-with-licenses dkms nvidia-settings nvidia-driver-G06-kmp-default \
    nvidia-driver-G06-kmp-longterm nvidia-userspace-meta-G06

    echo "amd_iommu=on iommu=pt rd.driver.blacklist=nouveau,nova_core modprobe.blacklist=nouveau,nova_core splash=silent mitigations=auto quiet security=selinux selinux=1" | sudo tee /etc/kernel/cmdline > /dev/null
}

install_lact(){
    sudo zypper -n install dbus-1-daemon
    flatpak install --user -y flathub io.github.ilya_zlobintsev.LACT
    sudo cp -r "$HOME"/.local/share/dsks-tools/configs/lact /etc/lact
    sudo chown root:root /etc/lact -R
    sudo usermod -aG wheel "$USER"
    echo "amd_iommu=on iommu=pt amdgpu.ppfeaturemask=0xffffffff splash=silent mitigations=auto quiet security=selinux selinux=1" | sudo tee /etc/kernel/cmdline > /dev/null
}

install_packages(){
    cd "$HOME"/.local/share/dsks-tools/temp || exit
    sudo zypper addrepo https://download.opensuse.org/repositories/systemsmanagement:cockpit/openSUSE_Tumbleweed/systemsmanagement:cockpit.repo
    sudo zypper -n install --auto-agree-with-licenses  git git-gui distrobox cpu-x remmina steam \
    opi clamav firewall-applet virt-manager steam-devices gamemode docker-compose-switch podman \
    setroubleshoot-server systemd-zram-service zram-generator nextcloud-desktop v4l2loopback-autoload \
    v4l2loopback-kmp-default v4l2loopback-kmp-longterm cockpit cockpit-selinux libvirt xfburn kate \
    kate-plugins kleopatra partitionmanager cockpit-snapshots

    sudo opi -n brave-browser
    sudo opi -n megasync

    cd "$HOME"/.local/share/dsks-tools/temp || exit
    curl -L -o proton-mail.rpm $PROTON_MAIL
    curl -L -o proton-pass.rpm $PROTON_PASS
    curl -L -o proton-authenticator.rpm $PROTON_AUTH
    sudo zypper -n install --allow-unsigned-rpm *.rpm
    rm *.rpm
    
    sudo zypper addrepo -cfp 80 'https://ftp.gwdg.de/pub/linux/misc/packman/suse/openSUSE_Tumbleweed/' packman
    sudo zypper --gpg-auto-import-keys -n ref

    sudo zypper -n install --from packman --allow-vendor-change ffmpeg gstreamer-plugins-good \
    gstreamer-plugins-bad gstreamer-plugins-ugly gstreamer-plugins-libav libavcodec \

    # install nodejs
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.4/install.sh | bash
    source ~/.bashrc
    nvm install lts/*

    flatpak install --user -y flathub com.github.tchx84.Flatseal io.podman_desktop.PodmanDesktop \
    io.missioncenter.MissionCenter it.mijorus.gearlever io.github.arunsivaramanneo.GPUViewer \
    org.gtkhash.gtkhash com.vysp3r.ProtonPlus com.github.Matoking.protontricks info.cemu.Cemu \
    org.DolphinEmu.dolphin-emu com.obsproject.Studio org.raspberrypi.rpi-imager \
    com.discordapp.Discord dev.goats.xivlauncher com.usebottles.bottles net.lutris.Lutris \
    org.freedesktop.Platform.VulkanLayer.MangoHud/x86_64/25.08 org.kde.kaffeine \
    org.kde.isoimagewriter

    sudo zypper -n rm lftp kmahjongg kmines kreversi ksudoku icewm icewm-config-upstream \
    yast2-firewall yast2-network yast2-country yast2-printer yast2-proxy yast2-scanner \
    yast2-services-manager xscreensaver xscreensaver-data gnome-mahjongg swell-foop \
    quadrapassel gnome-mines gnome-chess lightsoff gnome-sudoku cheese gnome-extensions \
    totem gnome-photos xterm yast2-kdump vlc vlc-qt vlc-codec-gstreamer vlc-codecs 
    sudo zypper -n dup
}

install_server_packages(){
    cd "$HOME"/.local/share/dsks-tools/temp || exit
    sudo zypper -n install --auto-agree-with-licenses  git opi clamav firewall-applet \
    setroubleshoot-server systemd-zram-service zram-generator cockpit cockpit-selinux \
    partitionmanager kernel-longterm zenity patterns-server-lamp_server nextcloud-apache 

    DESKTOP_TYPE=$XDG_CURRENT_DESKTOP
    if [ "$DESKTOP_TYPE" == "KDE" ]
    then
        sudo zypper -n install kate kate-plugins kleopatra
    elif [ "$DESKTOP_TYPE" == "GNOME" ]
    then
        sudo zypper -n install gnome-tweaks dconf-editor file-roller yaru-icon-theme
    else
        echo "$DESKTOP_TYPE is not supported."
    fi

    sudo opi -n brave-browser

    cd "$HOME"/.local/share/dsks-tools/temp || exit
    curl -L -o proton-pass.rpm $PROTON_PASS
    curl -L -o proton-authenticator.rpm $PROTON_AUTH
    sudo zypper -n install --allow-unsigned-rpm *.rpm
    rm *.rpm

    # install nodejs
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.4/install.sh | bash
    source ~/.bashrc
    nvm install lts/*

    flatpak install --user -y flathub com.github.tchx84.Flatseal io.missioncenter.MissionCenter

    sudo zypper -n rm lftp kmahjongg kmines kreversi ksudoku icewm icewm-config-upstream \
    yast2-firewall yast2-network yast2-country yast2-printer yast2-proxy yast2-scanner \
    yast2-services-manager xscreensaver xscreensaver-data gnome-mahjongg swell-foop \
    quadrapassel gnome-mines gnome-chess lightsoff gnome-sudoku cheese gnome-extensions \
    totem gnome-photos xterm yast2-kdump vlc vlc-qt vlc-codec-gstreamer vlc-codecs 
    sudo zypper -n dup
}

DEVICE=$(uname -n)
sudo flatpak remote-delete "flathub"
flatpak remote-add --user --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
if [ "$DEVICE" == "DesktopLnx" ]
then
    install_lact
    install_packages
    zenity --warning --text="Reminder to restart terminal so it sees nodejs to install bash lsp"
elif [ "$DEVICE" == "LaptopLnx" ]
then
    install_nvidia
    install_packages
    zenity --warning --text="Reminder to restart terminal so it sees nodejs to install bash lsp"
elif [ "$DEVICE" == "SERVER" ]
then
    install_server_packages
    zenity --warning --text="Reminder to restart terminal so it sees nodejs to install bash lsp"
else
    echo "error"
fi
