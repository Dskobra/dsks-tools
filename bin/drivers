#!/usr/bin/bash
install_nvidia(){
    # main drivers
    sudo zypper -n install --auto-agree-with-licenses openSUSE-repos-Tumbleweed-NVIDIA

    sudo zypper al nvidia-open-driver-G06-signed-kmp-default
    sudo zypper al nvidia-open-driver-G07-signed-kmp-default

    sudo zypper al nvidia-open-driver-G06-signed-kmp-longterm
    sudo zypper al nvidia-open-driver-G07-signed-kmp-longterm

    sudo zypper al nvidia-open-driver-G06-signed-cuda-kmp-default
    sudo zypper al nvidia-open-driver-G07-signed-cuda-kmp-default

    # cuda drivers
    sudo zypper al nvidia-open-driver-G06-signed-cuda-kmp-longterm
    sudo zypper al nvidia-open-driver-G07-signed-cuda-kmp-longterm

    sudo zypper --gpg-auto-import-keys -n ref
    sudo zypper -n install --auto-agree-with-licenses dkms nvidia-settings nvidia-driver-G06-kmp-default \
    nvidia-driver-G06-kmp-longterm nvidia-userspace-meta-G06

    echo "amd_iommu=on iommu=pt rd.driver.blacklist=nouveau,nova_core modprobe.blacklist=nouveau,nova_core splash=silent mitigations=auto quiet security=selinux selinux=1" | sudo tee /etc/kernel/cmdline > /dev/null
}

install_lact(){
    sudo zypper -n install dbus-1-daemon
    flatpak install --user -y flathub io.github.ilya_zlobintsev.LACT
    sudo cp -r "$HOME"/.local/share/dsks-tools/configs/lact /etc/lact
    sudo chown root:root /etc/lact -R
    sudo usermod -aG wheel "$USER"
    echo "amd_iommu=on iommu=pt amdgpu.ppfeaturemask=0xffffffff splash=silent mitigations=auto quiet security=selinux selinux=1" | sudo tee /etc/kernel/cmdline > /dev/null


}

if [ "$1" == "lact" ]
then
    install_lact
elif [ "$1" == "nvidia" ]
then
    install_nvidia
else
    echo "error"
fi